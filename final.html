<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설문 완료</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', '맑은 고딕', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 30px;
            color: #2c3e50;
            text-align: center;
        }

        .intro-text {
            font-size: 18px;
            color: #444;
            margin-bottom: 25px;
            text-align: center;
        }

        .choice-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .choice-card {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 22px 26px;
            border: 1px solid #dfe6ec;
            border-radius: 16px;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.2s;
            background-color: #fff;
            text-align: center;
        }

        .choice-card:hover {
            border-color: #3498db;
            box-shadow: 0 12px 24px rgba(52,152,219,0.15);
            transform: translateY(-2px);
        }

        .choice-card input[type="radio"] {
            transform: scale(1.35);
            margin: 0;
        }

        .choice-media-wrapper {
            flex-shrink: 0;
            width: 100%;
        }

        .choice-media {
            width: 100%;
            height: auto;
            border-radius: 14px;
            object-fit: cover;
            background-color: #000;
            border: 1px solid #ccd6dd;
        }

        .choice-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .choice-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .choice-desc {
            font-size: 15px;
            color: #555;
            line-height: 1.4;
        }

        .choice-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
        }

        .choice-card-header .choice-title {
            margin: 0;
        }

        .optional-question {
            margin-top: 10px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .optional-question textarea {
            width: 100%;
            min-height: 140px;
            margin-top: 12px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
        }

        .optional-question textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 4px rgba(52,152,219,0.3);
        }

        .btn-container {
            text-align: center;
            margin-top: 30px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
            padding: 12px 48px;
            font-size: 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-back {
            background-color: #f2f4f7;
            color: #2c3e50;
            padding: 10px 20px;
            font-size: 16px;
            border: 1px solid #c6d1e0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-back:hover {
            background-color: #e0e6f0;
        }

        .nav-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }


        .btn-primary:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            font-size: 15px;
            display: none;
        }

        .thank-you {
            margin-top: 30px;
            text-align: center;
            padding: 25px;
            border-radius: 10px;
            background-color: #ecf9f1;
            border: 1px solid #b7e4c7;
        }

        .thank-you h2 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 640px) {
            .choice-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .choice-media {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <script src="loading.js"></script>
    <div class="container">
        <div class="nav-actions">
            <button type="button" class="btn-back" onclick="handleBack()">이전으로 돌아가기</button>
        </div>
        <div id="questionSection">
            <h1>마무리 질문</h1>
            <p class="intro-text">
                <span style="font-size:22px;"><u><strong>영상을 보면서 댓글을 읽는 경험 측면에서서</strong></u>가장 만족스러웠던 인터페이스를 선택해 주세요.</span>
            </p>

            <form id="preferenceForm">
                <div class="choice-list" id="choiceList">
                    <!-- 인터페이스 카드가 동적으로 추가됩니다 -->
                </div>
                <div class="error-message" id="choiceError">하나의 인터페이스를 선택해 주세요.</div>

                <div class="optional-question">
                    <span style="font-size:22px;">(선택 사항) 위에서 가장 만족스럽다고 고른 인터페이스에 대해, 그 <u><strong>이유</strong></u>를 자유롭게 작성해 주세요.</span><br>
                    <span style="font-size:19px;"><br>*어떤 점이 마음에 들었는지, 구체적인 사례나 느낀 점을 포함해 설명해 주시면 좋습니다.</span><br>
                    <textarea id="preferenceReason" placeholder="자유롭게 작성해 주세요. (선택 사항)"></textarea>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn-primary" id="submitBtn">제출하기</button>
                </div>
            </form>
        </div>

        <div class="thank-you hidden" id="thankYouMessage">
            <h2>참여해 주셔서 감사합니다!</h2>
            <p>응답이 저장되었습니다. 추가로 궁금한 사항이 있으시면 언제든지 010-3610-8659 (김민선) 으로 연락 주세요.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const questionSection = document.getElementById('questionSection');
        const form = document.getElementById('preferenceForm');
        const choiceList = document.getElementById('choiceList');
        const choiceError = document.getElementById('choiceError');
        const reasonInput = document.getElementById('preferenceReason');
        const submitBtn = document.getElementById('submitBtn');
        const thankYouMessage = document.getElementById('thankYouMessage');

        let baseResultData = null;
        let interfaceOptions = [];
        const SUPABASE_URL = 'https://qrochowykynmdhyikcjd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFyb2Nob3d5a3lubWRoeWlrY2pkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwODM4ODAsImV4cCI6MjA3OTY1OTg4MH0.pdnjDMltF0kmSFOKiJL5wJIYTwtFLZWdaRUTUxhvaf4';
        const supabaseClient = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const QUESTION_LABELS = {
            '[Mental Demand] 이 인터페이스에서 댓글을 제시하는 방식이 영상 시청 과정에 정신적으로 부담을 주었나요?': 'Q1',
            '[Physical Demand] 이 인터페이스에서 댓글을 제시하는 방식이 영상 시청 과정에 신체적으로 부담을 주었나요?': 'Q2',
            '[Contextual Alignment] 이 인터페이스에서 재생 중에 제시되는 댓글이 해당 장면과 잘 어울렸나요?': 'Q3',
            '[Overall Engagement] 영상 내용과 상관 없이 이 인터페이스에서 댓글을 제시하는 방식이 영상 시청 경험에 즐거움/흥미/참여감(engagement) 측면에서 만족스러웠나요?': 'Q4'
        };

        function createMediaElement(path) {
            const lowerPath = (path || '').toLowerCase();
            if (lowerPath.endsWith('.mp4') || lowerPath.endsWith('.webm')) {
                const video = document.createElement('video');
                video.className = 'choice-media';
                video.src = path;
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                video.setAttribute('aria-hidden', 'true');
                return video;
            }

            const img = document.createElement('img');
            img.className = 'choice-media';
            img.src = path;
            img.alt = '인터페이스 미리보기';
            return img;
        }

        function handleBack() {
            if (document.referrer) {
                history.back();
            } else {
                window.location.href = 'test.html';
            }
        }

        function renderChoices() {
            if (!choiceList) return;

            choiceList.innerHTML = '';
            const options = interfaceOptions.length > 0 ? interfaceOptions : getDefaultInterfaceDescriptions();

            options.forEach(choice => {
                const label = document.createElement('label');
                label.className = 'choice-card';

                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'interfaceChoice';
                radio.value = choice.id;

                const header = document.createElement('div');
                header.className = 'choice-card-header';
                header.appendChild(radio);

                const title = document.createElement('div');
                title.className = 'choice-title';
                title.textContent = choice.title;
                header.appendChild(title);

                const mediaWrapper = document.createElement('div');
                mediaWrapper.className = 'choice-media-wrapper';
                mediaWrapper.appendChild(createMediaElement(choice.media));

                const desc = document.createElement('div');
                desc.className = 'choice-desc';
                desc.innerHTML = choice.description || choice.desc || '';

                label.appendChild(header);
                label.appendChild(mediaWrapper);
                label.appendChild(desc);

                choiceList.appendChild(label);
            });
        }

        async function prepareBaseResult() {
            const participantData = JSON.parse(localStorage.getItem('participantData') || 'null');
            if (!participantData) {
                alert('참가자 정보를 찾을 수 없습니다. 처음 페이지로 이동합니다.');
                window.location.href = 'index.html';
                return;
            }

            const testResults = getAllTestResults();
            const testSequence = await getOrCreateInterfaceDataPairs();

            baseResultData = {
                participant: participantData,
                testSequence,
                results: testResults
            };
        }

        function buildQuestionScores(results, sequence) {
            const scoreMap = {};
            const interfaceMeta = {};

            (sequence || []).forEach(pair => {
                if (!pair || !pair.interface) return;
                interfaceMeta[pair.interface] = {
                    dataFolder: pair.data || '',
                    htmlFile: pair.htmlFile || '',
                    dataPath: pair.dataPath || ''
                };
            });

            (results || []).forEach(result => {
                if (!result.interface) {
                    return;
                }
                if (!scoreMap[result.interface]) {
                    scoreMap[result.interface] = {
                        dataFolder: interfaceMeta[result.interface]?.dataFolder || '',
                        htmlFile: interfaceMeta[result.interface]?.htmlFile || '',
                        dataPath: interfaceMeta[result.interface]?.dataPath || '',
                        scores: {}
                    };
                }
                (result.answers || []).forEach((answer, idx) => {
                    const idxFromData = typeof answer.questionIndex === 'number' ? answer.questionIndex : idx;
                    const fallbackLabel = `Q${idxFromData + 1}`;
                    const label = answer.questionId || QUESTION_LABELS[answer.questionText] || fallbackLabel;
                    scoreMap[result.interface].scores[label] = answer.answer;
                });
            });

            return scoreMap;
        }

        function getSelectedChoice() {
            return document.querySelector('input[name="interfaceChoice"]:checked');
        }

        function showThankYouOnly() {
            if (questionSection) {
                questionSection.classList.add('hidden');
            }
            if (thankYouMessage) {
                thankYouMessage.classList.remove('hidden');
            }
        }

        async function submitToSupabase(finalData) {
            if (!supabaseClient) {
                console.error('Supabase 클라이언트를 초기화할 수 없습니다.');
                alert('응답 저장 시스템을 불러오지 못했습니다. 관리자에게 문의해주세요.');
                return false;
            }

            const payload = {
                name: finalData.participant?.name || '',
                age: finalData.participant?.age ?? null,
                gender: finalData.participant?.gender || '',
                question_scores: buildQuestionScores(finalData.results, finalData.testSequence),
                preferred_interface: finalData.preferredInterface || '',
                preferred_reason: finalData.preferredReason || '',
                created_at: finalData.completedAt
            };

            const { error } = await supabaseClient.from('survey_responses').insert(payload);

            if (error) {
                console.error('Supabase 저장 오류:', error);
                alert('응답 저장 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
                return false;
            }
            return true;
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!submitBtn) return;

            const selected = getSelectedChoice();
            if (!selected) {
                choiceError.style.display = 'block';
                window.scrollTo({ top: choiceList.offsetTop - 20, behavior: 'smooth' });
                return;
            }
            choiceError.style.display = 'none';

            submitBtn.disabled = true;

            if (!baseResultData) {
                await prepareBaseResult();
                if (!baseResultData) {
                    submitBtn.disabled = false;
                    return;
                }
            }

            const finalData = {
                ...baseResultData,
                preferredInterface: selected.value,
                preferredReason: reasonInput.value.trim(),
                completedAt: new Date().toISOString()
            };

            const saved = await submitToSupabase(finalData);
            if (!saved) {
                submitBtn.disabled = false;
                return;
            }

            localStorage.setItem('finalResults', JSON.stringify(finalData));
            console.log('최종 결과:', finalData);

            showThankYouOnly();
        });

        async function initializeFinalPage() {
            const loader = window.PageLoader;
            try {
                loader?.setMessage?.('마무리 질문을 준비하는 중입니다...');
                loader?.show?.();
                interfaceOptions = await loadInterfaceDescriptions();
                renderChoices();
                if (choiceList && loader?.waitForMedia) {
                    await loader.waitForMedia(choiceList);
                }
                await prepareBaseResult();
            } catch (error) {
                console.error('최종 페이지를 초기화하지 못했습니다.', error);
            } finally {
                loader?.hide?.();
            }
        }

        document.addEventListener('DOMContentLoaded', initializeFinalPage);
    </script>
</body>
</html>

