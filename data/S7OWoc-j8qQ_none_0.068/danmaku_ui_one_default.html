<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Home Alone (1990) - Thirsty for More? Scene (4/5) | Movieclips</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    :root {
      --bg: #ffffff;
      --video-bg: #000;
      --accent: #ff0000;
      --text: #fff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #fff; /* í°ìƒ‰ ë°°ê²½ */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .video-title {
      width: 800px;
      margin-top: 40px;
      margin-bottom: 5px;
      text-align: left;
      font-size: 20px;
      font-weight: 600;
      color: #000;
      padding: 0;
      line-height: 1.4;
    }

    .video-container {
      width: 800px;
      margin-top: 20px;
      position: relative;
      background-color: #000;
      overflow: hidden;
      border-radius: 20px; /* ìœ íŠœë¸Œ ëŠë‚Œì˜ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
      transition: all 0.3s ease;
    }

    video {
      width: 100%;
      display: block;
      object-fit: cover;
      border-radius: 12px; /* ë¹„ë””ì˜¤ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
    }

    /* ê¸°ë³¸ ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ ì™„ì „íˆ ìˆ¨ê¸°ê¸° */
    video::-webkit-media-controls-panel { display: none !important; }
    video::-webkit-media-controls-play-button { display: none !important; }
    video::-webkit-media-controls-start-playback-button { display: none !important; }
    video::-moz-media-controls { display: none !important; }
    video::--ms-media-controls { display: none !important; }

    /* ì»¤ìŠ¤í…€ ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ */
    .custom-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      padding: 4px 15px 4px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 4;
      border-radius: 0 0 12px 12px;
    }

    .video-container:hover .custom-controls { opacity: 1; }

    .progress-container {
      width: 100%;
      height: 3px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      margin-bottom: 6px;
      position: relative;
      cursor: pointer;
    }

    .progress-bar {
      height: 100%;
      background: #ff0000;
      border-radius: 3px;
      width: 0%;
      position: relative;
      transition: width 0.1s ease;
    }

    .progress-handle {
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: #ff0000;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .progress-container:hover .progress-handle { opacity: 1; }

    .controls-bottom {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .control-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      padding: 8px;
      border-radius: 3px;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-button:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .control-button svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    .time-display {
      color: white;
      font-size: 13px;
      font-weight: 500;
    }

    /* ë‹¨ë¬´ì¿  ëŒ“ê¸€ */
    .danmaku-comment {
      position: absolute;
      color: white;
      font-size: 18px;
      font-weight: normal;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
      text-shadow:
        -1px -1px 0 #000,
         1px -1px 0 #000,
        -1px  1px 0 #000,
         1px  1px 0 #000;
    }

    .comment-text {
      font-size: 18px;
      color: white;
      font-weight: normal;
    }


  </style>
</head>
  <body>
    <!-- ì œëª©ì„ ì˜ìƒ ìœ„ì— ë°°ì¹˜ -->
    <div class="video-container" id="video-container">
    <video id="video-player" preload="metadata">
      <!-- í…œí”Œë¦¿ ì—”ì§„ì´ ì£¼ì…í•˜ê±°ë‚˜ ì•„ë˜ srcë¡œ ëŒ€ì²´í•˜ì„¸ìš” -->
      <source src="../video/S7OWoc-j8qQ.mp4" type="video/mp4" />
      ë¸Œë¼ìš°ì €ê°€ video íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </video>

    <!-- ì»¤ìŠ¤í…€ ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ -->
    <div class="custom-controls">
      <div class="progress-container" id="progress-container" aria-label="progress">
        <div class="progress-bar" id="progress-bar">
          <div class="progress-handle"></div>
        </div>
      </div>
      <div class="controls-bottom">
        <button class="control-button" id="play-pause-btn" aria-label="play/pause">
          <svg id="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
          <svg id="pause-icon" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <div class="time-display" id="time-display">0:00 / 0:00</div>
      </div>
    </div>
  </div>

  <script>
    // ===== ìœ í‹¸ =====
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function formatTime(sec){ const m = Math.floor(sec/60); const s = Math.floor(sec%60).toString().padStart(2,'0'); return m + ':' + s; }
    
    // ë¬¸ìì—´ì„ í•´ì‹œê°’ìœ¼ë¡œ ë³€í™˜ (ì¼ê´€ëœ ëœë¤ ìœ„ì¹˜ ìƒì„±ìš©)
    function hashString(str) {
      let hash = 0;
      if (str.length === 0) return hash;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // 32bit ì •ìˆ˜ë¡œ ë³€í™˜
      }
      return Math.abs(hash);
    }

    // ì„œë²„ì—ì„œ ì£¼ì…ë˜ëŠ” ë‹¨ë¬´ì¿  ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì˜ˆ: [{ start: 1.2, text: "í•˜ì´" }, ...]
    // í…œí”Œë¦¿ì´ ì—†ë‹¤ë©´ ì•„ë˜ fallback ì‚¬ìš©
    var danmakuComments = (typeof [{"start": 0, "text": "Woah .. lol.. hilarious scene.. my old time favorite Christmas movie since I was 8 years old:)", "correlation": 0.5627563821357832}, {"start": 10, "text": "especally id theres a Christmas tree   tree", "correlation": 0.429608133886351}, {"start": 13, "text": "So Kevin put ornaments on the floor, knowing that his glue stairs trap would have someone's shoes removed for it to work?", "correlation": 0.5136483804039826}, {"start": 14, "text": "0:14 ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£Every year I still laugh at this funny trap on Marv ğŸ¤£ğŸ¤£ğŸ¤£My favourite Christmas film ever", "correlation": 0.39052129613822234}, {"start": 15, "text": "@0:11 He's smiling.ğŸ˜€ğŸ˜€ğŸ˜€ @0:15 He's in Pain ğŸ˜«ğŸ˜«ğŸ˜«", "correlation": 0.31159506380504776}, {"start": 19, "text": "IM GOING TO KILL THAT KID", "correlation": 0.905297603894565}, {"start": 25, "text": "Lol, the ornaments on the floor is always hilarious. Especially when he steps on the yellow one walking away", "correlation": 0.539266491904222}, {"start": 29, "text": "@Love_That_3MixÂ  he did walk through all the snow", "correlation": 0.3796584458463426}, {"start": 33, "text": "Even for this film being 30 now, itâ€™s still a decent holiday movie.", "correlation": 0.3019559170773488}, {"start": 36, "text": "Marv and Harry", "correlation": 0.8123241994259245}, {"start": 37, "text": "Harry!! Heâ€™s in the living room!!", "correlation": 0.6964781114719084}, {"start": 39, "text": "0:39 Why'd the hell you take your shoes?", "correlation": 0.8179229617093079}, {"start": 41, "text": "why the hell you dressed like a chicken 0:41", "correlation": 0.8874448153510192}, {"start": 42, "text": "0:42 â€œwhy the hell are you dressed like a chickenâ€ ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚", "correlation": 0.7099813064283084}, {"start": 43, "text": "Why the hell you dressed like a chicken. ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£", "correlation": 0.9638807421481067}, {"start": 45, "text": "I'm up here you morons, come and get me", "correlation": 0.9743451066686784}, {"start": 47, "text": "Well, itâ€™s almost that time of the year once again, so here I am.", "correlation": 0.3873609296074008}, {"start": 49, "text": "I love the way they both fall down on the toy carsğŸ˜‚ğŸ˜‚", "correlation": 0.4087652676674091}, {"start": 52, "text": "Kevin:guys give up or your thirsty for more?", "correlation": 0.7631824532744004}, {"start": 53, "text": "@JoshuaSmith-c8mÂ  0:53 you guys give up or ya thirsty for more? ğŸ˜", "correlation": 0.6673068049286639}, {"start": 55, "text": "You guys give up, or are you thirsty for more?", "correlation": 0.9806334246512907}, {"start": 65, "text": "Heads up! Huh?", "correlation": 0.7569872472822472}, {"start": 66, "text": "1:06 Headshot! 1:13 Headshot Number 2!", "correlation": 0.3506635499865579}, {"start": 68, "text": "Right!? Another one Second film: Gets hit by brick dies", "correlation": 0.3929116994527183}, {"start": 69, "text": "@TravonJamelGreenÂ  Donâ€™t worry, Marv. Iâ€™ll get him for ya!", "correlation": 0.6537359256901426}, {"start": 70, "text": "Donâ€™t worry, Marv. Iâ€™ll get â€˜im for ya.", "correlation": 0.8545333763084771}, {"start": 71, "text": "1:11 the amount of fear in Marv's \"Harry!\" ğŸ˜‚ğŸ˜‚ğŸ˜‚", "correlation": 0.3920765067488125}, {"start": 72, "text": "1:12 the first paint is a different paint can", "correlation": 0.48649998125710137}, {"start": 73, "text": "Ow!", "correlation": 1.0}, {"start": 74, "text": "I like the part where they both slipped on those toy cars.", "correlation": 0.4085830152038774}, {"start": 76, "text": "Yes hahahahah ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜€ğŸ˜€ğŸ˜€", "correlation": 0.43988106132231297}, {"start": 78, "text": "Yes!!!", "correlation": 0.7413974503189418}, {"start": 82, "text": "He's only a kid,harry. We can take him.", "correlation": 0.9941763858986216}, {"start": 85, "text": "Aw shut up will you!", "correlation": 0.8299038189919288}, {"start": 86, "text": "You're missing some teeth.", "correlation": 0.6150067997886608}, {"start": 88, "text": "1:28 You're missing some teeth.", "correlation": 0.49172291452987665}, {"start": 90, "text": "\"where? It's my gold tooth. My gold tooth. I'll kill him! I'll kill him!\"", "correlation": 0.9155431411168076}, {"start": 91, "text": "1:31 Where? Itâ€™s my gold tooth.", "correlation": 0.5651937838383153}, {"start": 92, "text": "At 1:32 or 1:33, speaking of the gold tooth that was knocked out of Harry's mouth-it was later found and picked up by Peter at the end of the film, however,  I wonder what Peter had done to the gold tooth.ğŸ¦·ğŸ”", "correlation": 0.5548169616751248}, {"start": 94, "text": "@anthonyvega-fujioka4464Â  What? Where's my gold tooth? - My gold tooth - I'll kill him - I'll kill him gets up and starts up the stairs \"YOU BOMBARD ME WITH ONE MORE PAINT CAN, AND I'LL SNAP OFF YOUR CAJONES AND PUT 'EM IN MOTOR OIL!\"", "correlation": 0.7906392879668419}, {"start": 98, "text": "1:38 - You bomb me with one more can, kid, and I'll snap off your cajones, and boil them in motor oil!", "correlation": 0.7832251071187457}, {"start": 100, "text": "If you bomb me with one more can kid Iâ€™ll snap all of your cojones burn em in motor oil 1:40  ğŸ˜‚ğŸ˜‚", "correlation": 0.8552955915869165}, {"start": 105, "text": "You bop me with ONE MORE can, kid and I'll SNAP your cojones and throw em in my motor oil!!", "correlation": 0.9345323055484658}, {"start": 107, "text": "1:47 and only at this point in the movie he decides to call the cops!? ğŸ˜‚", "correlation": 0.31267437940063597}, {"start": 108, "text": "Hello, my house is being robbed", "correlation": 0.733762020274888}, {"start": 111, "text": "Help! My house is being robbed. My address is 656 Lincoln Boulevard. My nameâ€™s Murphy.", "correlation": 0.6363986679643985}, {"start": 123, "text": "I love this movie home alone", "correlation": 0.6413106549694532}, {"start": 129, "text": "The movie should be the whole movie", "correlation": 0.39767330759951036}, {"start": 134, "text": "I watch this every year, this movie is very funny and the pranks on the first film and the second film are just funny and the pranks are the same and a little different", "correlation": 0.5080695203808732}] !== 'undefined' ? [{"start": 0, "text": "Woah .. lol.. hilarious scene.. my old time favorite Christmas movie since I was 8 years old:)", "correlation": 0.5627563821357832}, {"start": 10, "text": "especally id theres a Christmas tree   tree", "correlation": 0.429608133886351}, {"start": 13, "text": "So Kevin put ornaments on the floor, knowing that his glue stairs trap would have someone's shoes removed for it to work?", "correlation": 0.5136483804039826}, {"start": 14, "text": "0:14 ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£Every year I still laugh at this funny trap on Marv ğŸ¤£ğŸ¤£ğŸ¤£My favourite Christmas film ever", "correlation": 0.39052129613822234}, {"start": 15, "text": "@0:11 He's smiling.ğŸ˜€ğŸ˜€ğŸ˜€ @0:15 He's in Pain ğŸ˜«ğŸ˜«ğŸ˜«", "correlation": 0.31159506380504776}, {"start": 19, "text": "IM GOING TO KILL THAT KID", "correlation": 0.905297603894565}, {"start": 25, "text": "Lol, the ornaments on the floor is always hilarious. Especially when he steps on the yellow one walking away", "correlation": 0.539266491904222}, {"start": 29, "text": "@Love_That_3MixÂ  he did walk through all the snow", "correlation": 0.3796584458463426}, {"start": 33, "text": "Even for this film being 30 now, itâ€™s still a decent holiday movie.", "correlation": 0.3019559170773488}, {"start": 36, "text": "Marv and Harry", "correlation": 0.8123241994259245}, {"start": 37, "text": "Harry!! Heâ€™s in the living room!!", "correlation": 0.6964781114719084}, {"start": 39, "text": "0:39 Why'd the hell you take your shoes?", "correlation": 0.8179229617093079}, {"start": 41, "text": "why the hell you dressed like a chicken 0:41", "correlation": 0.8874448153510192}, {"start": 42, "text": "0:42 â€œwhy the hell are you dressed like a chickenâ€ ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚", "correlation": 0.7099813064283084}, {"start": 43, "text": "Why the hell you dressed like a chicken. ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£ğŸ¤£", "correlation": 0.9638807421481067}, {"start": 45, "text": "I'm up here you morons, come and get me", "correlation": 0.9743451066686784}, {"start": 47, "text": "Well, itâ€™s almost that time of the year once again, so here I am.", "correlation": 0.3873609296074008}, {"start": 49, "text": "I love the way they both fall down on the toy carsğŸ˜‚ğŸ˜‚", "correlation": 0.4087652676674091}, {"start": 52, "text": "Kevin:guys give up or your thirsty for more?", "correlation": 0.7631824532744004}, {"start": 53, "text": "@JoshuaSmith-c8mÂ  0:53 you guys give up or ya thirsty for more? ğŸ˜", "correlation": 0.6673068049286639}, {"start": 55, "text": "You guys give up, or are you thirsty for more?", "correlation": 0.9806334246512907}, {"start": 65, "text": "Heads up! Huh?", "correlation": 0.7569872472822472}, {"start": 66, "text": "1:06 Headshot! 1:13 Headshot Number 2!", "correlation": 0.3506635499865579}, {"start": 68, "text": "Right!? Another one Second film: Gets hit by brick dies", "correlation": 0.3929116994527183}, {"start": 69, "text": "@TravonJamelGreenÂ  Donâ€™t worry, Marv. Iâ€™ll get him for ya!", "correlation": 0.6537359256901426}, {"start": 70, "text": "Donâ€™t worry, Marv. Iâ€™ll get â€˜im for ya.", "correlation": 0.8545333763084771}, {"start": 71, "text": "1:11 the amount of fear in Marv's \"Harry!\" ğŸ˜‚ğŸ˜‚ğŸ˜‚", "correlation": 0.3920765067488125}, {"start": 72, "text": "1:12 the first paint is a different paint can", "correlation": 0.48649998125710137}, {"start": 73, "text": "Ow!", "correlation": 1.0}, {"start": 74, "text": "I like the part where they both slipped on those toy cars.", "correlation": 0.4085830152038774}, {"start": 76, "text": "Yes hahahahah ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜‚ğŸ˜€ğŸ˜€ğŸ˜€", "correlation": 0.43988106132231297}, {"start": 78, "text": "Yes!!!", "correlation": 0.7413974503189418}, {"start": 82, "text": "He's only a kid,harry. We can take him.", "correlation": 0.9941763858986216}, {"start": 85, "text": "Aw shut up will you!", "correlation": 0.8299038189919288}, {"start": 86, "text": "You're missing some teeth.", "correlation": 0.6150067997886608}, {"start": 88, "text": "1:28 You're missing some teeth.", "correlation": 0.49172291452987665}, {"start": 90, "text": "\"where? It's my gold tooth. My gold tooth. I'll kill him! I'll kill him!\"", "correlation": 0.9155431411168076}, {"start": 91, "text": "1:31 Where? Itâ€™s my gold tooth.", "correlation": 0.5651937838383153}, {"start": 92, "text": "At 1:32 or 1:33, speaking of the gold tooth that was knocked out of Harry's mouth-it was later found and picked up by Peter at the end of the film, however,  I wonder what Peter had done to the gold tooth.ğŸ¦·ğŸ”", "correlation": 0.5548169616751248}, {"start": 94, "text": "@anthonyvega-fujioka4464Â  What? Where's my gold tooth? - My gold tooth - I'll kill him - I'll kill him gets up and starts up the stairs \"YOU BOMBARD ME WITH ONE MORE PAINT CAN, AND I'LL SNAP OFF YOUR CAJONES AND PUT 'EM IN MOTOR OIL!\"", "correlation": 0.7906392879668419}, {"start": 98, "text": "1:38 - You bomb me with one more can, kid, and I'll snap off your cajones, and boil them in motor oil!", "correlation": 0.7832251071187457}, {"start": 100, "text": "If you bomb me with one more can kid Iâ€™ll snap all of your cojones burn em in motor oil 1:40  ğŸ˜‚ğŸ˜‚", "correlation": 0.8552955915869165}, {"start": 105, "text": "You bop me with ONE MORE can, kid and I'll SNAP your cojones and throw em in my motor oil!!", "correlation": 0.9345323055484658}, {"start": 107, "text": "1:47 and only at this point in the movie he decides to call the cops!? ğŸ˜‚", "correlation": 0.31267437940063597}, {"start": 108, "text": "Hello, my house is being robbed", "correlation": 0.733762020274888}, {"start": 111, "text": "Help! My house is being robbed. My address is 656 Lincoln Boulevard. My nameâ€™s Murphy.", "correlation": 0.6363986679643985}, {"start": 123, "text": "I love this movie home alone", "correlation": 0.6413106549694532}, {"start": 129, "text": "The movie should be the whole movie", "correlation": 0.39767330759951036}, {"start": 134, "text": "I watch this every year, this movie is very funny and the pranks on the first film and the second film are just funny and the pranks are the same and a little different", "correlation": 0.5080695203808732}] : null);
    if(!Array.isArray(danmakuComments)){
      danmakuComments = [
        { start: 0.5, text: "ì²« ëŒ“ê¸€!" },
        { start: 1.5, text: "ì˜¤ë¥¸ìª½ì—ì„œ ë“±ì¥í•©ë‹ˆë‹¤" },
        { start: 3.0, text: "ì™¼ìª½ìœ¼ë¡œ ì‚¬ë¼ì ¸ìš”" },
        { start: 5.0, text: "ì‹œí‚¹í•´ë„ ì˜ ë™ì‘" },
      ];
    }

    // ===== ìš”ì†Œ ì°¸ì¡° / ì „ì—­ ìƒíƒœ =====
    var video = null;
    var videoContainer = null;
    var playPauseBtn = null, playIcon = null, pauseIcon = null;
    var progressContainer = null, progressBar = null;
    var timeDisplay = null;

    var isDragging = false;          // ì§„í–‰ë°” ë“œë˜ê·¸
    var activeDanmaku = new Map();   // idx -> { element, currentX, width, y, speed }
    var animationId = null;
    var isPaused = false;            // ë¹„ë””ì˜¤ ì •ì§€ ë™ê¸°í™”
    var lastRafTime = 0;             // requestAnimationFrame ì‹œê°„
    var lastVideoTime = 0;           // ì§ì „ timeupdateì˜ ë¹„ë””ì˜¤ ì‹œê°„ (ì‹œí‚¹ ëŒ€ë¹„)
    
    // danmaku one ì „ìš©: ë‹¤ìŒì— í‘œì‹œí•  ëŒ“ê¸€ ì¸ë±ìŠ¤
    var nextCommentIndex = 0;
    var displayedComments = new Set();  // ì´ë¯¸ í‘œì‹œëœ ëŒ“ê¸€ ì¸ë±ìŠ¤ ì¶”ì 
    
    // ëŒ“ê¸€ë³„ ê³ ìœ  ì†ë„ ê³„ì‚° í•¨ìˆ˜ (í”½ì…€ ë‹¨ìœ„ë¡œ ë„¤ ê°œ ì¤‘ í•˜ë‚˜)
    function getDanmakuSpeed(commentText) {
      const textHash = hashString(commentText || '');
      const speedOptions = [-140, -180, -220, -260]; // px/s (ìŒìˆ˜=ì™¼ìª½)
      return speedOptions[textHash % speedOptions.length];
    }

    document.addEventListener('DOMContentLoaded', function(){
      video = document.getElementById('video-player');
      videoContainer = document.getElementById('video-container');
      playPauseBtn = document.getElementById('play-pause-btn');
      playIcon = document.getElementById('play-icon');
      pauseIcon = document.getElementById('pause-icon');
      progressContainer = document.getElementById('progress-container');
      progressBar = document.getElementById('progress-bar');
      timeDisplay = document.getElementById('time-display');

      // start ê¸°ì¤€ ì •ë ¬
      danmakuComments.sort((a,b) => a.start - b.start);

      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      video.addEventListener('timeupdate', onTimeUpdate);
      video.addEventListener('loadedmetadata', updateTimeDisplay);
      video.addEventListener('play', () => { updatePlayPauseButton(); lastVideoTime = video.currentTime || 0; resumeAllDanmaku(); });
      video.addEventListener('pause', () => { updatePlayPauseButton(); pauseAllDanmaku(); });
      video.addEventListener('seeking', resetDanmakuForSeek);

      playPauseBtn.addEventListener('click', togglePlayPause);
      progressContainer.addEventListener('mousedown', startDrag);
      document.addEventListener('mousemove', doDrag);
      document.addEventListener('mouseup', endDrag);
      progressContainer.addEventListener('click', (e)=>{ if(!isDragging) seekVideo(e); });

      // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ í˜„ì¬ ë– ìˆëŠ” ë‹¨ë¬´ì¿  ìœ„ì¹˜/í‡´ì¥ íŒì • ë³´ì •
      window.addEventListener('resize', () => {
        // í° ë ˆì´ì•„ì›ƒ ë³€í™”ì—ì„œëŠ” ê°„ë‹¨íˆ ë¦¬ì…‹
        resetDanmakuForSeek();
      });

      // ì´ˆê¸° ìƒíƒœ
      updatePlayPauseButton();
    });

    function togglePlayPause(){ if(video.paused) video.play(); else video.pause(); }

    function updatePlayPauseButton(){
      if(!video) return;
      if(video.paused){
        playIcon.style.display='block';
        pauseIcon.style.display='none';
      } else {
        playIcon.style.display='none';
        pauseIcon.style.display='block';
      }
    }

    function updateTimeDisplay(){
      if(!video || !video.duration) return;
      const cur = formatTime(video.currentTime || 0);
      const tot = formatTime(video.duration);
      timeDisplay.textContent = cur + ' / ' + tot;
    }

    function onTimeUpdate(){
      if(!video) return;
      const t = video.currentTime || 0;

      // ì§„í–‰ë°”
      if(video.duration){
        progressBar.style.width = ((t / video.duration) * 100) + '%';
      }
      updateTimeDisplay();

      // danmaku one: ì²« ë²ˆì§¸ ëŒ“ê¸€ë§Œ onTimeUpdateì—ì„œ í‘œì‹œ (í™œì„± ëŒ“ê¸€ì´ ì—†ê³  ì²« ë²ˆì§¸ ëŒ“ê¸€ì¼ ë•Œë§Œ)
      // ì´í›„ ëŒ“ê¸€ë“¤ì€ updateDanmakuPositionsì—ì„œ ì´ì „ ëŒ“ê¸€ì´ ì™„ì „íˆ ì‚¬ë¼ì§„ í›„ì—ë§Œ í‘œì‹œë¨
      if(activeDanmaku.size === 0 && nextCommentIndex === 0 && !displayedComments.has(0) && nextCommentIndex < danmakuComments.length){
        const firstComment = danmakuComments[0];
        if(firstComment && t >= firstComment.start){
          addDanmakuComment(firstComment, 0);
          displayedComments.add(0);
          nextCommentIndex = 1;
          if (!animationId) startAnimationLoop();
        }
      }

      lastVideoTime = t;
    }

    // ===== ì§„í–‰ë°” ì œì–´ =====
    function startDrag(e){ isDragging = true; e.preventDefault(); updateVideoTime(e); }
    function doDrag(e){ if(!isDragging) return; e.preventDefault(); updateVideoTime(e); }
    function endDrag(){ if(!isDragging) return; isDragging = false; }
    function seekVideo(e){ updateVideoTime(e); }

    function updateVideoTime(e){
      const rect = progressContainer.getBoundingClientRect();
      const pos = clamp((e.clientX - rect.left)/rect.width, 0, 1);
      if (video.duration) {
        video.currentTime = pos * video.duration;
        // ì‹œí‚¹ ì²˜ë¦¬: ë– ìˆëŠ” ë‹¨ë¬´ì¿  ì´ˆê¸°í™” & íƒ€ì„ ë§ˆì»¤ ê°±ì‹ 
        resetDanmakuForSeek();
      }
    }

    // ===== ë‹¨ë¬´ì¿  ìƒì„± / ì• ë‹ˆë©”ì´ì…˜ =====
    function addDanmakuComment(cmt, idx){
      const div = document.createElement('div');
      div.className = 'danmaku-comment';
      div.id = 'danmaku-' + idx;

      const txt = (cmt.text ?? '') + '';
      div.innerHTML = '<div class="comment-text"></div>';
      div.querySelector('.comment-text').textContent = txt; // XSS ì•ˆì „

      // ì„¸ë¡œ ìœ„ì¹˜: ëŒ“ê¸€ í…ìŠ¤íŠ¸ ê¸°ë°˜ ê²°ì •ì  ìœ„ì¹˜ (í•˜ë‹¨ ì—¬ë°± 10px)
      const containerRect = videoContainer.getBoundingClientRect();
      // ëŒ“ê¸€ í…ìŠ¤íŠ¸ë¥¼ í•´ì‹œê°’ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì¼ê´€ëœ ìœ„ì¹˜ ìƒì„±
      const textHash = hashString(cmt.text || '');
      const maxHeight = containerRect.height - 20; // í•˜ë‹¨ 10px ì—¬ë°±
      const randomY = textHash % maxHeight; // ìƒë‹¨ë¶€í„° ì‹œì‘

      // ë¨¼ì € ë¶™ì—¬ì„œ ì‹¤ì œ ë„ˆë¹„ë¥¼ ì°ë‹¤
      div.style.top = randomY + 'px';
      div.style.left = '0px';
      div.style.transform = 'translateX(0px)';
      div.style.transition = 'none';
      videoContainer.appendChild(div);

      const elWidth = div.getBoundingClientRect().width;

      // ì‹œì‘ X: ì»¨í…Œì´ë„ˆ ì˜¤ë¥¸ìª½ ë°”ê¹¥
      const startX = containerRect.width; // +10 ë²„í¼
      div.style.transform = `translateX(${startX}px)`;

      // ëŒ“ê¸€ë³„ ê³ ìœ  ì†ë„ ê³„ì‚°
      const danmakuSpeed = getDanmakuSpeed(cmt.text);

      // ìƒíƒœ ì €ì¥
      activeDanmaku.set(idx, {
        element: div,
        currentX: startX,
        width: elWidth,
        y: randomY,
        speed: danmakuSpeed
      });

      // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ ê°€ë™
      if (!animationId) startAnimationLoop();
    }

    function startAnimationLoop() {
      function animate(ts) {
        if (!lastRafTime) lastRafTime = ts;
        const deltaTime = (ts - lastRafTime) / 1000; // ì´ˆ
        lastRafTime = ts;

        if (!isPaused) {
          updateDanmakuPositions(deltaTime);
        }

        // ë£¨í”„ ìœ ì§€: í™œì„± ë‹¨ë¬´ì¿ ê°€ ì—†ê³  ë¹„ë””ì˜¤ë„ ì¼ì‹œì •ì§€ë©´ ë©ˆì¶œ ìˆ˜ ìˆìŒ
        if (activeDanmaku.size === 0 && video?.paused) {
          animationId = null;
          lastRafTime = 0;
          return; // ë£¨í”„ ì¢…ë£Œ
        }
        animationId = requestAnimationFrame(animate);
      }
      if (!animationId) animationId = requestAnimationFrame(animate);
    }

    function updateDanmakuPositions(deltaTime) {
      // ê° ëŒ“ê¸€ë³„ ê³ ìœ  ì†ë„ë¡œ ì™¼ìª½ ì´ë™
      var commentJustDisappeared = false;
      
      activeDanmaku.forEach((danmaku, idx) => {
        if (!danmaku || !danmaku.element) return;
        danmaku.currentX += danmaku.speed * deltaTime;

        // ì™„ì „ í‡´ì¥: ìš”ì†Œì˜ ì˜¤ë¥¸ìª½ ëì´ í™”ë©´ ì™¼ìª½ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
        if (danmaku.currentX + danmaku.width < 0) {
          danmaku.element.parentNode?.removeChild(danmaku.element);
          activeDanmaku.delete(idx);
          commentJustDisappeared = true;
        } else {
          danmaku.element.style.transform = `translateX(${danmaku.currentX}px)`;
        }
      });
      
      // danmaku one: ëŒ“ê¸€ì´ ì™„ì „íˆ ì‚¬ë¼ì§„ ì§í›„, ê·¸ ì‹œì  ì´í›„ì˜ ëŒ“ê¸€ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ëŒ“ê¸€ í‘œì‹œ
      if (commentJustDisappeared && activeDanmaku.size === 0) {
        const t = video?.currentTime || 0;
        
        // í˜„ì¬ ì‹œê°„ ì´í›„ì˜ ëŒ“ê¸€ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ëŒ“ê¸€ ì°¾ê¸° (ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì€ ëŒ“ê¸€ë§Œ)
        var nextComment = null;
        var nextCommentIdx = -1;
        
        for (let i = 0; i < danmakuComments.length; i++) {
          // ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì•˜ê³ , ì‹œì‘ ì‹œê°„ì´ í˜„ì¬ ì‹œê°„ ì´í›„ì¸ ëŒ“ê¸€ ì°¾ê¸°
          if (!displayedComments.has(i) && danmakuComments[i].start >= t) {
            nextComment = danmakuComments[i];
            nextCommentIdx = i;
            break;
          }
        }
        
        // ì°¾ì€ ëŒ“ê¸€ì´ ìˆìœ¼ë©´ í‘œì‹œ
        if (nextComment && nextCommentIdx >= 0) {
          addDanmakuComment(nextComment, nextCommentIdx);
          displayedComments.add(nextCommentIdx);
          nextCommentIndex = nextCommentIdx + 1;
        }
      }
    }

    // ===== ì‹œí‚¹/ì¬ìƒ ë™ê¸°í™” =====
    function pauseAllDanmaku() { isPaused = true; }
    function resumeAllDanmaku() { isPaused = false; if (!animationId) startAnimationLoop(); }

    function resetDanmakuForSeek(){
      // ë– ìˆë˜ ê²ƒë“¤ ì œê±°
      activeDanmaku.forEach((d)=>{ d.element?.parentNode?.removeChild(d.element); });
      activeDanmaku.clear();
      // ë‹¤ìŒ í”„ë ˆì„ ê¸°ì¤€ìœ¼ë¡œ ìƒˆë¡œ íŠ¸ë¦¬ê±°
      lastVideoTime = video?.currentTime || 0;
      // ì• ë‹ˆë©”ì´ì…˜ íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
      lastRafTime = 0;
      // danmaku one: ë‹¤ìŒ ëŒ“ê¸€ ì¸ë±ìŠ¤ ì¬ê³„ì‚° (í˜„ì¬ ì‹œê°„ ì´í›„ì˜ ì²« ë²ˆì§¸ ëŒ“ê¸€ ì°¾ê¸°)
      displayedComments.clear();  // ì‹œí‚¹ ì‹œ í‘œì‹œëœ ëŒ“ê¸€ ì¶”ì  ì´ˆê¸°í™”
      nextCommentIndex = 0;
      for(let i = 0; i < danmakuComments.length; i++){
        if(danmakuComments[i].start > lastVideoTime){
          nextCommentIndex = i;
          break;
        }
      }
    }
  </script>
</body>
</html>
